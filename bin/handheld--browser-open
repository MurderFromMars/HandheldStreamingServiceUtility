#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-or-later

###############################################################################
# Input handling
###############################################################################

REQUESTED_BROWSER="$1"
TARGET_URL="$2"

# Default browser if none provided
if [ -z "$REQUESTED_BROWSER" ]; then
    REQUESTED_BROWSER="com.google.Chrome"
fi

# URL must be provided by caller
if [ -z "$TARGET_URL" ]; then
    zenity --error --text="No URL was provided to the browser launcher."
    exit 1
fi

###############################################################################
# Browser availability check
###############################################################################

if ! flatpak info "$REQUESTED_BROWSER" >/dev/null 2>&1; then

    # Convert Flatpak ID → human name for the popup
    case "$REQUESTED_BROWSER" in
        com.google.Chrome)
            FRIENDLY_NAME="Google Chrome"
            ;;
        com.microsoft.Edge)
            FRIENDLY_NAME="Microsoft Edge"
            ;;
        *)
            FRIENDLY_NAME="$REQUESTED_BROWSER"
            ;;
    esac

    zenity --info \
        --text="The required browser (${FRIENDLY_NAME}) is not installed.\n\nPlease switch to Desktop Mode and install it from Discover."

    exit 1
fi

###############################################################################
# Environment cleanup
###############################################################################

# Steam Deck sometimes injects LD_PRELOAD — remove it for Flatpak apps
unset LD_PRELOAD

###############################################################################
# Launch browser in kiosk mode
###############################################################################

/usr/bin/flatpak run \
    --arch=x86_64 \
    --branch=stable \
    --file-forwarding \
    "$REQUESTED_BROWSER" \
    @@u \
    @@ \
    --window-size="1024,640" \
    --force-device-scale-factor="1.25" \
    --device-scale-factor="1.25" \
    --kiosk \
    "$TARGET_URL"
