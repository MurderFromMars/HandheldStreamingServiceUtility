#!/usr/bin/env bash
# Kiosk-mode browser launcher for gaming handhelds

set -euo pipefail

readonly FLATPAK_BIN="/usr/bin/flatpak"
readonly DISPLAY_WIDTH="1024"
readonly DISPLAY_HEIGHT="640"
readonly SCALE_FACTOR="1.25"

# Browser display name mapping
declare -A BROWSER_NAMES=(
    ["com.google.Chrome"]="Google Chrome"
    ["com.microsoft.Edge"]="Microsoft Edge"
    ["com.brave.Browser"]="Brave Browser"
)

# Validate flatpak installation
check_browser_installed() {
    local flatpak_id="$1"
    flatpak info "${flatpak_id}" &>/dev/null
}

# Show installation prompt
prompt_install() {
    local browser_name="$1"
    zenity --info \
        --title="Browser Not Found" \
        --text="Please install ${browser_name} from Discover (Desktop Mode) before launching this application."
}

# Launch browser in kiosk configuration
launch_kiosk() {
    local flatpak_id="$1"
    local url="$2"
    
    # Clear Steam overlay library
    unset LD_PRELOAD
    
    exec "${FLATPAK_BIN}" run \
        --arch=x86_64 \
        --branch=stable \
        --file-forwarding \
        "${flatpak_id}" \
        @@u @@ \
        --window-size="${DISPLAY_WIDTH},${DISPLAY_HEIGHT}" \
        --force-device-scale-factor="${SCALE_FACTOR}" \
        --device-scale-factor="${SCALE_FACTOR}" \
        --kiosk \
        "${url}"
}

# Main execution
main() {
    local browser_id="${1:-com.google.Chrome}"
    local target_url="${URL:-${2:-}}"
    
    # Validate inputs
    if [[ -z "${target_url}" ]]; then
        echo "Error: No URL specified" >&2
        exit 1
    fi
    
    # Check if browser exists
    if ! check_browser_installed "${browser_id}"; then
        local display_name="${BROWSER_NAMES[${browser_id}]:-Unknown Browser}"
        prompt_install "${display_name}"
        exit 1
    fi
    
    # Execute in kiosk mode
    launch_kiosk "${browser_id}" "${target_url}"
}

main "$@"
